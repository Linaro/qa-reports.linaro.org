########################################################################
### munin setup
########################################################################

- name: Install munin-node
  apt:
    pkg: munin-node
    state: present
    update-cache: yes

- name: munin plugins for squad
  register: munin_squad_plugins
  copy:
    src: munin/{{item}}
    dest: /etc/munin/plugins/{{item}}
    owner: root
    group: root
    mode: 0755
  with_items:
    - squad_processes
    - squad_job_count
    - squad_queue

- name: configure munin plugins for squad
  copy:
    src: munin/plugins.conf
    dest: /etc/munin/plugin-conf.d/squad
    owner: root
    group: root
    mode: 0644
  register: munin_squad_plugins_conf

- name: configure munin-node hostname
  register: munin_node_conf_hostname
  lineinfile:
    dest: /etc/munin/munin-node.conf
    line: "host_name {{ inventory_hostname }}"

- name: configure munin-node network access
  register: munin_node_conf_cidr_allow
  lineinfile:
    dest: /etc/munin/munin-node.conf
    line: "cidr_allow {{ hostvars[master_hostname].ansible_default_ipv4.address }}/32"

- name: restart munin-node
  when: munin_node_conf_hostname.changed or munin_node_conf_cidr_allow.changed or munin_squad_plugins.changed or munin_squad_plugins_conf.changed
  command: systemctl restart munin-node

- name: Install munin
  when: master_node
  apt:
    pkg: munin
    state: present
    update-cache: yes

- name: Configure munin
  when: master_node
  template:
    src: roles/squad/templates/munin.conf
    dest: /etc/munin/munin.conf
  register: munin_conf

- name: run munin on configurations changes
  when: 'master_node and (munin_conf.changed or munin_squad_plugins.changed or munin_squad_plugins_conf.changed)'
  command: runuser -u munin munin-cron
